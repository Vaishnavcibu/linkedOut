<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Job Details | LinkedOut</title>
    <link rel="stylesheet" href="../public/css/style.css">
    <style>
        /* ... existing styles ... */
        .applicant-card { padding: 1.5rem 0; border-bottom: 1px solid var(--border-color); }
        .applicant-card:last-child { border-bottom: none; }
        .cover-letter-content {
            display: none; /* Hidden by default */
            margin-top: 1rem;
            padding: 1rem;
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            white-space: pre-wrap; /* Preserves formatting of the cover letter */
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <header class="header"><!-- Dynamic Header --></header>

    <main class="container" style="padding-top: 100px;">
        <!-- ... back link ... -->
        <div class="details-grid">
            <!-- Column 1: Job Details (remains the same) -->
            <div id="job-details-section"> ... </div>
            <!-- Column 2: Application Statistics -->
            <div>
                <div class="glass-card">
                    <h2>Statistics</h2>
                    <h1 id="application-count" style="font-size: 3rem; margin: 1rem 0;"></h1>
                    <h4>Applicants</h4>
                    <div id="applicant-list" style="margin-top: 1rem;"></div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="../public/js/main.js"></script>
    <script>
        $(document).ready(function() {
            const jobId = window.location.pathname.split('/').pop();
            const $applicantList = $('#applicant-list');

            $.get(`/api/jobs/${jobId}/details`, function(data) {
                // ... code to populate job details section ...
                
                $('#application-count').text(data.applicationCount);

                // ** LOGIC HAS CHANGED HERE **
                if (data.applications.length === 0) {
                    $applicantList.html('<p>No applications yet.</p>');
                } else {
                    $applicantList.empty();
                    data.applications.forEach(app => {
                        const applicant = app.applicant;
                        if (!applicant) return; // Skip if applicant data is missing

                        $applicantList.append(`
                            <div class="applicant-card">
                                <strong>${applicant.name}</strong>
                                <p style="font-size: 0.9rem; color: var(--text-muted-color);">${applicant.email}</p>
                                <div class="skills-list" style="margin-top: 0.5rem;">
                                    ${applicant.skills.map(s => `<span>${s}</span>`).join('')}
                                </div>
                                <div style="margin-top: 1rem;">
                                    <a href="/${applicant.resumeUrl.replace(/\\/g, '/')}" target="_blank" class="btn btn-login" style="margin-right: 0.5rem;">View Resume</a>
                                    <button class="btn show-letter-btn" data-target="#letter-${app._id}">Show Cover Letter</button>
                                </div>
                                <div class="cover-letter-content" id="letter-${app._id}">${app.coverLetter}</div>
                            </div>
                        `);
                    });
                }
            }).fail(function() { /* ... error handling ... */ });

            // ** NEW EVENT HANDLER to show/hide the letter **
            $applicantList.on('click', '.show-letter-btn', function() {
                const targetId = $(this).data('target');
                const $letterContent = $(targetId);
                
                $letterContent.slideToggle(300);

                // Change button text for better user experience
                const isVisible = $letterContent.is(':visible');
                $(this).text(isVisible ? 'Show Cover Letter' : 'Hide Cover Letter');
            });
        });
    </script>
</body>
</html>