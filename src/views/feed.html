<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Job Feed | LinkedOut</title>
    <link rel="stylesheet" href="../public/css/style.css">
    <link rel="stylesheet" href="../public/css/feed.css">
</head>
<body>
    <header class="header">
        <div class="container navbar">
            <a href="/" class="logo"><div class="logo-icon"></div>LinkedOut</a>
            <ul class="nav-links"></ul> <!-- Dynamic -->
            <div class="nav-buttons"></div> <!-- Dynamic -->
        </div>
    </header>

    <main class="feed-container">
        <div class="swipe-deck">
            <!-- Cards will be dynamically inserted here -->
        </div>
        <div class="swipe-actions">
            <button id="reject" class="action-btn" aria-label="Reject">‚ùå</button>
            <button id="accept" class="action-btn" aria-label="Accept">‚úîÔ∏è</button>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="../public/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const deck = document.querySelector('.swipe-deck');
            const acceptBtn = document.getElementById('accept');
            const rejectBtn = document.getElementById('reject');
            let currentCards = [];

            async function fetchAndInitializeCards() {
                try {
                    const response = await fetch('/api/jobs/feed');
                    if (!response.ok) {
                         // If not authenticated, the middleware redirects. Let's redirect on client too.
                         if(response.status === 401) window.location.href = '/login';
                        throw new Error('Failed to fetch jobs');
                    }
                    const jobs = await response.json();
                    deck.innerHTML = ''; 

                    if (jobs.length === 0) {
                        deck.innerHTML = '<p class="no-more-cards">No more opportunities for now. Check back later!</p>';
                        return;
                    }

                    jobs.forEach(job => {
                        const card = document.createElement('div');
                        card.className = 'swipe-card';
                        card.id = job._id;
                        card.innerHTML = `
                            <div class="card-content">
                                <h3 class="job-title">${job.title}</h3>
                                <p class="company-name">${job.company}</p>
                                <div class="job-details">
                                    <p>üìç ${job.location}</p>
                                    <p>üïí ${job.jobType}</p>
                                    ${job.salary && job.salary.details ? `<p>üí∞ ${job.salary.details}</p>` : ''}
                                </div>
                                <div class="job-skills">${job.skillsRequired.map(s => `<span>${s}</span>`).join('')}</div>
                            </div>`;
                        deck.appendChild(card);
                    });
                    initializeCardEventListeners();
                } catch (error) {
                    console.error('Error fetching jobs:', error);
                    deck.innerHTML = '<p class="no-more-cards">Could not load jobs.</p>';
                }
            }

            function initializeCardEventListeners() {
                currentCards = Array.from(deck.querySelectorAll('.swipe-card'));
                currentCards.forEach((card, index) => {
                    card.style.zIndex = currentCards.length - index;
                    const hammer = new Hammer(card);
                    hammer.on('pan', e => onPan(e.target, e));
                    hammer.on('panend', e => onPanEnd(e.target, e));
                });
                updateUiStack();
            }

            function onPan(card, event) {
                if (!card.classList.contains('is-active')) return;
                card.classList.add('dragging');
                card.style.transform = `translateX(${event.deltaX}px) rotate(${event.deltaX / 10}deg)`;
            }

            function onPanEnd(card, event) {
                if (!card.classList.contains('is-active')) return;
                card.classList.remove('dragging');
                if (Math.abs(event.deltaX) > 120) {
                    swipeCard(card, event.deltaX > 0 ? 'right' : 'left');
                } else {
                    card.style.transform = '';
                }
            }

            function swipeCard(card, direction) {
                if (!card || !currentCards.includes(card)) return;
                const endX = direction === 'right' ? window.innerWidth : -window.innerWidth;
                card.style.transform = `translateX(${endX * 1.5}px) rotate(${direction === 'right' ? 30 : -30}deg)`;
                card.style.opacity = '0';
                
                fetch(`/api/jobs/swipe/${card.id}/${direction}`, { method: 'POST' });
                
                currentCards = currentCards.filter(c => c !== card);
                setTimeout(() => card.remove(), 400);
                updateUiStack();

                if (currentCards.length === 0) {
                    setTimeout(() => deck.innerHTML = '<p class="no-more-cards">Feed cleared. Check back later!</p>', 500);
                }
            }
            
            function updateUiStack() {
                currentCards.forEach((card, index) => {
                    card.classList.remove('is-active');
                    if (index === currentCards.length - 1) { // Top
                        card.style.transform = 'scale(1) translateY(0)';
                        card.classList.add('is-active');
                    } else if (index === currentCards.length - 2) { // Middle
                        card.style.transform = 'scale(0.95) translateY(-20px)';
                    } else { // Bottom
                        card.style.transform = 'scale(0.9) translateY(-40px)';
                    }
                });
            }

            acceptBtn.addEventListener('click', () => {
                if(currentCards.length > 0) swipeCard(currentCards[currentCards.length - 1], 'right');
            });
            rejectBtn.addEventListener('click', () => {
                 if(currentCards.length > 0) swipeCard(currentCards[currentCards.length - 1], 'left');
            });

            fetchAndInitializeCards();
        });
    </script>
</body>
</html>